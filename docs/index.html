<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dotbox UI - Component Library</title>
    <link rel="icon" type="image/svg+xml" href="./assets/dotbox_logo_only.svg">
    <link rel="stylesheet" href="/dist/index.css">
    <link rel="stylesheet" href="/dist/theme.css">
    <link rel="stylesheet" href="./docs.css">
</head>
<body>
    <nav class="nav">
        <div class="logo">
            <img src="./assets/dotbox_logo_only.svg" alt="Dotbox Logo">
            <span class="logo-text">Dotbox <span style="color: var(--color-text);">UI</span></span>
        </div>
        <div id="theme-dropdown-container" style="margin-bottom: 0.75rem;"></div>
        <div id="type-dropdown-container" style="margin-bottom: 0.75rem;"></div>
        <hr style="border: none; border-top: 1px solid var(--color-border); margin: 1rem 0;">
        <div id="nav-menu"></div>
    </nav>

    <div class="content">
        <div class="container">
            <!-- Intro Section -->
            <section class="component-section">
                <h2 class="component-title" style="font-family: 'SilomBol', sans-serif;">Dotbox UI Components</h2>
                <p class="component-description">A modern, lightweight UI component library for building beautiful web applications.</p>
            </section>

            <!-- Dynamic component sections will be inserted here -->
            <div id="dynamic-sections"></div>
        </div>
    </div>

    <script src="/dist/bundle.js"></script>
    <script>
        // Global components data
        let componentsData = [];

        // Load components configuration
        async function loadComponentsData() {
            try {
                const response = await fetch('./components.json');
                componentsData = await response.json();
                initializeDocumentation();
            } catch (error) {
                console.error('Failed to load components data:', error);
                // Fallback to empty array
                componentsData = [];
                initializeDocumentation();
            }
        }

        function initializeDocumentation() {
            createNavigationMenu();
            createComponentSections();
            setupThemeDropdown();
            setupTypeDropdown();
            setInitialTheme();
            // Apply initial filter (Web Components only)
            updateCodeExampleVisibility();
        }

        function createNavigationMenu() {
            const navItems = componentsData.map(comp => ({
                id: comp.id,
                label: comp.name
            }));

            const navMenu = new Dotbox.Menu({
                items: navItems,
                selected: navItems[0]?.id || '',
                bordered: false,
                routingMode: true,
                onSelect: (id) => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.scrollIntoView({ behavior: 'smooth' });
                    }
                }
            });

            document.getElementById('nav-menu').appendChild(navMenu.getElement());
        }

        function createComponentSections() {
            const dynamicSections = document.getElementById('dynamic-sections');

            componentsData.forEach(component => {
                // Create section
                const section = document.createElement('section');
                section.id = component.id;
                section.className = 'component-section';

                // Create title and description
                section.innerHTML = `
                    <h2 class="component-title">${component.name}</h2>
                    <p class="component-description">${component.description}</p>
                    
                    <div class="component-demo">
                        <div id="${component.id}-wc-section" style="margin-bottom: 2rem;">
                            <div id="${component.id}-wc-demo"></div>
                        </div>
                        
                        <div id="${component.id}-js-section">
                            <div id="${component.id}-js-demo"></div>
                        </div>
                    </div>

                    <div class="component-code">
                        <div id="${component.id}-code-demo"></div>
                    </div>
                `;

                dynamicSections.appendChild(section);

                // Create live Web Component demos (parse and execute the HTML)
                createLiveDemo(component.id + '-wc-demo', component.codeWC);

                // Create JavaScript API demos (execute only JavaScript parts)
                createJSDemo(component.id + '-js-demo', component);

                // Create code examples
                createCodeExample(component.id + '-code-demo', component);
            });
        }

        function createLiveDemo(containerId, wcCode) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Extract HTML parts (not script tags) and insert them
            const htmlParts = wcCode.replace(/<script[\s\S]*?<\/script>/gi, '');
            container.innerHTML = htmlParts;

            // Extract and execute script parts
            const scriptMatches = wcCode.match(/<script[\s\S]*?<\/script>/gi);
            if (scriptMatches) {
                scriptMatches.forEach(scriptTag => {
                    // Extract just the JavaScript code (remove script tags)
                    const scriptContent = scriptTag.replace(/<\/?script[^>]*>/gi, '');
                    try {
                        // Create a new script element and execute it
                        const scriptElement = document.createElement('script');
                        scriptElement.textContent = scriptContent;
                        document.head.appendChild(scriptElement);
                        // Remove it immediately after execution to avoid duplicates
                        document.head.removeChild(scriptElement);
                    } catch (error) {
                        console.error('Error executing Web Component demo script:', error);
                    }
                });
            }
        }

        function createJSDemo(containerId, component) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Use JSON data for JS demos too - execute the script parts
            executeScriptFromCode(component.codeJS, container);
        }

        function executeScriptFromCode(code, container) {
            // Extract and execute script parts from JSON code
            const scriptMatches = code.match(/<script[\s\S]*?<\/script>/gi);
            if (scriptMatches) {
                scriptMatches.forEach(scriptTag => {
                    // Extract just the JavaScript code (remove script tags)
                    const scriptContent = scriptTag.replace(/<\/?script[^>]*>/gi, '');
                    try {
                        // Replace document.body.appendChild with container.appendChild for demos
                        const modifiedScript = scriptContent.replace(
                            /document\.body\.appendChild/g, 
                            `arguments[0].appendChild`
                        );
                        
                        // Create a function and execute it with container as argument
                        const scriptFunction = new Function(modifiedScript);
                        scriptFunction.call(null, container);
                    } catch (error) {
                        console.error('Error executing JS demo script:', error);
                    }
                });
            }
        }


        function createCodeExample(containerId, component) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Combine both Web Components and JavaScript examples
            const combinedCode = component.codeWC + '\n\n' + component.codeJS;

            const codeBlock = new Dotbox.CodeBlock({
                language: 'html',
                code: combinedCode.replace(/\\n/g, '\n')
            });

            container.appendChild(codeBlock.getElement());
        }


        // Global filter state
        let currentCodeType = 'webcomponents'; // 'webcomponents', 'javascript'

        function setupThemeDropdown() {
            const themeDropdown = new Dotbox.Dropdown({
                label: 'Theme',
                allowNull: false, // No placeholder/null option
                options: [
                    { value: 'light', label: 'Light' },
                    { value: 'dark', label: 'Dark' }
                ],
                value: localStorage.getItem('dotbox-theme') || 'light',
                size: 'small',
                onChange: (e) => {
                    setTheme(e.target.value);
                }
            });
            document.getElementById('theme-dropdown-container').appendChild(themeDropdown.getContainer());
        }

        function setupTypeDropdown() {
            const typeDropdown = new Dotbox.Dropdown({
                label: 'Code Examples',
                allowNull: false, // No placeholder/null option
                options: [
                    { value: 'webcomponents', label: 'Web Components' },
                    { value: 'javascript', label: 'JavaScript API' }
                ],
                value: 'webcomponents', // Default to Web Components
                size: 'small',
                onChange: (e) => {
                    currentCodeType = e.target.value;
                    updateCodeExampleVisibility();
                }
            });
            document.getElementById('type-dropdown-container').appendChild(typeDropdown.getContainer());
        }

        function updateCodeExampleVisibility() {
            // Update all component sections based on filter
            componentsData.forEach(component => {
                const wcSection = document.getElementById(`${component.id}-wc-section`);
                const jsSection = document.getElementById(`${component.id}-js-section`);
                const codeDemo = document.getElementById(`${component.id}-code-demo`);

                if (wcSection && jsSection) {
                    // Show/hide demo sections
                    switch (currentCodeType) {
                        case 'webcomponents':
                            wcSection.style.display = 'block';
                            jsSection.style.display = 'none';
                            break;
                        case 'javascript':
                            wcSection.style.display = 'none';
                            jsSection.style.display = 'block';
                            break;
                        default:
                            wcSection.style.display = 'block';
                            jsSection.style.display = 'none';
                            break;
                    }
                }

                // Update code examples
                if (codeDemo) {
                    updateCodeExample(component.id + '-code-demo', component);
                }
            });
        }

        function updateCodeExample(containerId, component) {
            const container = document.getElementById(containerId);
            if (!container) return;

            // Clear existing code block
            container.innerHTML = '';

            let codeToShow = '';
            switch (currentCodeType) {
                case 'webcomponents':
                    codeToShow = component.codeWC;
                    break;
                case 'javascript':
                    codeToShow = component.codeJS;
                    break;
                default:
                    codeToShow = component.codeWC;
                    break;
            }

            const codeBlock = new Dotbox.CodeBlock({
                language: 'html',
                code: codeToShow.replace(/\\n/g, '\n')
            });

            container.appendChild(codeBlock.getElement());
        }

        function setTheme(theme) {
            document.documentElement.classList.remove('theme-light', 'theme-dark');
            document.documentElement.classList.add('theme-' + theme);
            localStorage.setItem('dotbox-theme', theme);
        }

        function setInitialTheme() {
            const saved = localStorage.getItem('dotbox-theme') || 'light';
            setTheme(saved);
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', loadComponentsData);
    </script>
</body>
</html>